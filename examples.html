<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Examples &mdash; madIS 1.9 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jsMath/easy/load.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="madIS 1.9 documentation" href="index.html" />
    <link rel="next" title="Row functions list" href="row.html" />
    <link rel="prev" title="Useful notes" href="usefulnotes.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="row.html" title="Row functions list"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="usefulnotes.html" title="Useful notes"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">madIS 1.9 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="pivot">
<h2>Pivot<a class="headerlink" href="#pivot" title="Permalink to this headline">¶</a></h2>
<p>First import data from a tsv file (Tab Separated Values) with <a class="reference internal" href="vtable.html#functions.vtable.file.file" title="functions.vtable.file.file"><tt class="xref py py-func docutils literal"><span class="pre">file()</span></tt></a> virtual table function.
<a class="reference download internal" href="_downloads/sales.tsv"><tt class="xref download docutils literal"><span class="pre">sales.tsv</span></tt></a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;&quot;&quot;create table sales as</span>
<span class="gp">... </span><span class="s">            select Product,Region,Month,cast(Sales as int) as Sales</span>
<span class="gp">... </span><span class="s">                from</span>
<span class="gp">... </span><span class="s">                    (file &#39;testing/sales.tsv&#39; &#39;dialect:tsv&#39; header:t)&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;select * from sales&quot;</span><span class="p">)</span>
<span class="go">Product | Region | Month   | Sales</span>
<span class="go">----------------------------------</span>
<span class="go">Cars    | Athens | 2010-01 | 200</span>
<span class="go">Cars    | Athens | 2010-02 | 130</span>
<span class="go">Bikes   | NY     | 2010-01 | 10</span>
<span class="go">Bikes   | NY     | 2010-02 | 30</span>
<span class="go">Cars    | NY     | 2010-01 | 100</span>
<span class="go">Cars    | NY     | 2010-02 | 160</span>
<span class="go">Cars    | Paris  | 2010-01 | 70</span>
<span class="go">Cars    | Paris  | 2010-02 | 20</span>
<span class="go">Bikes   | Paris  | 2010-01 | 100</span>
<span class="go">Bikes   | Paris  | 2010-02 | 20</span>
<span class="go">Boats   | Paris  | 2010-01 | 200</span>
</pre></div>
</div>
<p>Let&#8217;s say we want the result to be a table with columns:</p>
<ul class="simple">
<li>Product</li>
<li>NY: the total sales in NY for this product</li>
<li>Paris: the total sales in Paris for this product</li>
<li>Athens: the total sales in Athens for this product</li>
</ul>
<p>We will perform the aggregate function <em>sum</em> over <em>Sales</em> column, grouping by <em>Product</em> and <em>Region</em> columns.
Then <tt class="xref py py-func docutils literal"><span class="pre">vecpack()</span></tt> must be performed over <em>Region</em> and <em>Sales</em> sums, grouping on <em>Product</em>.</p>
<p>To use <tt class="xref py py-func docutils literal"><span class="pre">vecpack()</span></tt> the first argument must be a pack of the dimensions. This is the
result of packing the distinct <em>Region</em> values, grouping over all the table.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;&quot;&quot;select Product,unpackcol(vpck)</span>
<span class="gp">... </span><span class="s">     from</span>
<span class="gp">... </span><span class="s">       (select Product,vecpack(rpk,Region,salessum) as vpck</span>
<span class="gp">... </span><span class="s">        from</span>
<span class="gp">... </span><span class="s">            (select pack(distinct Region) as rpk from sales),</span>
<span class="gp">... </span><span class="s">            (select Product,Region,sum(sales) as salessum</span>
<span class="gp">... </span><span class="s">                from sales group by Product,Region)</span>
<span class="gp">... </span><span class="s">        group by Product)&quot;&quot;&quot;</span><span class="p">)</span>
<span class="go">Product | Paris | NY  | Athens</span>
<span class="go">------------------------------</span>
<span class="go">Bikes   | 120   | 40  | 0</span>
<span class="go">Boats   | 200   | 0   | 0</span>
<span class="go">Cars    | 90    | 260 | 330</span>
</pre></div>
</div>
</div>
<div class="section" id="application-scenario">
<span id="applexample"></span><h2>Application scenario<a class="headerlink" href="#application-scenario" title="Permalink to this headline">¶</a></h2>
<p>In this example we implement a simple application for query recommendation based on user&#8217;s country of origin. The input data come from a web portal&#8217;s logs.</p>
<p>The query mining workflow includes the following five main steps:</p>
<ol class="arabic simple">
<li>Import the portal log files into a relational table</li>
<li>Use time-heuristics so as to identify coherent query sessions.
Assign and store a new, reconstructed session id for each record in the logs</li>
<li>Preprocess and clean logged queries text</li>
<li>Retrieve IP-to-country information from the web and combine this with the IP information from portal log files
so as to assign a country code to each one of the logged sessions</li>
<li>Apply an <a class="reference external" href="http://en.wikipedia.org/wiki/Apriori_algorithm">Apriori-based</a> technique for extracting frequent term sets per country.</li>
</ol>
<p>A sample from the log file used is presented below:</p>
<div class="highlight-none"><div class="highlight"><pre>36506        guest   X.X.X.134       p93t9q5eqaa0u0p8isd9skp1n6      en      (&quot;paradis riedinger&quot;)   search_sim  2010-01-01 00:28:23
36507        guest   X.X.X.134       p93t9q5eqaa0u0p8isd9skp1n6      en      (&quot;paradis riedinger&quot;)   view_brief  2010-01-01 00:28:34
36508        guest   X.X.X.134       p93t9q5eqaa0u0p8isd9skp1n6      en      (&quot;paradis riedinger&quot;)   view_brief  2010-01-01 00:28:34
36509        guest   X.X.X.134       p93t9q5eqaa0u0p8isd9skp1n6      en      (&quot;paradis riedinger&quot;)   view_full  2010-01-01 00:28:42
36510        guest   X.X.X.55        a9qo379qnl5hbbria6tj6nlp95      de  (creator all &quot;frank leonhard&quot;)  search_adv  2010-01-01 00:28:44
36511        guest   X.X.X.55        a9qo379qnl5hbbria6tj6nlp95      de  (creator all &quot;frank leonhard&quot;)      view_brief  2010-01-01 00:29:10
36512        guest   X.X.X.55        a9qo379qnl5hbbria6tj6nlp95      de  (creator all &quot;frank leonhard&quot;)      search_res  2010-01-01 00:29:18
</pre></div>
</div>
<p><strong>Step 1</strong></p>
<p>Initially, log files which are available in the Tab Separated Value format, are imported into a relational table.
The import process is easily implemented in madIS using the <a class="reference internal" href="vtable.html#functions.vtable.file.file" title="functions.vtable.file.file"><tt class="xref py py-func docutils literal"><span class="pre">file()</span></tt></a> function,
by selecting the appropriate columns from the &#8221;.tsv&#8221; file.</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">logs</span> <span class="k">as</span>
   <span class="k">select</span> <span class="n">C1</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span> <span class="n">C2</span> <span class="k">as</span> <span class="n">userid</span><span class="p">,</span> <span class="n">C3</span> <span class="k">as</span> <span class="n">userip</span><span class="p">,</span> <span class="n">C4</span> <span class="k">as</span> <span class="n">sesid</span><span class="p">,</span> <span class="n">C6</span> <span class="k">as</span> <span class="n">query</span><span class="p">,</span> <span class="n">c7</span> <span class="k">as</span> <span class="n">action</span><span class="p">,</span> <span class="n">C8</span> <span class="k">as</span> <span class="kt">date</span>
   <span class="k">from</span> <span class="nf">file</span><span class="p">(</span><span class="s1">&#39;raw_logs.tsv&#39;</span><span class="p">,</span><span class="s1">&#39;delimiter:\t&#39;</span><span class="p">,</span><span class="s1">&#39;quoting:QUOTE_NONE&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Step 2</strong></p>
<p>Thereafter, session reconstruction, a common task in web usage mining, is performed.
In this example it uses a predefined inactivity thresholds to break in-coming sessions.
Such functionality is performed in madIS through the <a class="reference internal" href="aggregate.html#functions.aggregate.subgroup.datediffbreak" title="functions.aggregate.subgroup.datediffbreak"><tt class="xref py py-func docutils literal"><span class="pre">datediffbreak()</span></tt></a> function,
which takes as an argument the inactivity threshold (as well as some additional parameters) and returns the new session ids.
In the following madSQL segment, where the efficient employment of the described function is presented,
the inactivity threshold has been set to 30 minutes (provided in milliseconds).</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">alter</span> <span class="k">table</span> <span class="n">logs</span> <span class="k">add</span> <span class="n">sesidnew</span> <span class="kt">text</span><span class="p">;</span>
<span class="k">update</span> <span class="n">logs</span>
     <span class="kt">set</span> <span class="n">sesidnew</span><span class="o">=</span>
     <span class="p">(</span><span class="k">select</span> <span class="n">bgroupid</span>
             <span class="k">from</span>
             <span class="p">(</span> <span class="n">cache</span> <span class="k">select</span> <span class="nf">datediffbreak</span><span class="p">(</span><span class="n">sesid</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="kt">date</span><span class="p">,</span><span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="kt">date</span><span class="p">,</span><span class="n">id</span><span class="p">)</span>
                             <span class="k">from</span> <span class="n">logs</span>
                             <span class="k">where</span> <span class="n">sesid</span> <span class="k">not</span> <span class="no">null</span> <span class="k">group</span> <span class="k">by</span> <span class="n">sesid</span><span class="p">)</span>
             <span class="k">where</span> <span class="n">C1</span><span class="o">=</span><span class="n">id</span> <span class="p">)</span>
     <span class="k">where</span> <span class="n">sesid</span> <span class="k">is</span> <span class="k">not</span> <span class="no">null</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Step 3</strong></p>
<p>Then, focusing on issued queries, the distinct queries per session are retrieved from the logs
and a variety of query text processing steps take place.
However, a great amount of malformed queries has been observed, so it is only queries of valid text in utf8 encoding that are selected.
This filtering step is performed using the <a class="reference internal" href="row.html#functions.row.text.isvalidutf8" title="functions.row.text.isvalidutf8"><tt class="xref py py-func docutils literal"><span class="pre">isvalidutf8()</span></tt></a> function in the where clause of the corresponding madSQL fragment.</p>
<p>Thereafter, stop word removal is performed over the selected queries through the corresponding function.
Moreover, since queries are issued and logged using the Common Query Language (CQL) syntax, an additional filtering step is executed for removing <em>CQL</em> constructs,
through the madIS function <a class="reference internal" href="row.html#functions.row.text.cqlkeywords" title="functions.row.text.cqlkeywords"><tt class="xref py py-func docutils literal"><span class="pre">cqlkeywords()</span></tt></a>. The processed queries are then stored in table <em>QueriesPerSession</em>.
One of the advantages offered by madIS framework, is that all the powerful Python capabilities and
open source libraries for text processing can be exploited for the rapid implementation of customized functions,
hence significantly easing the “flow-level programming”, in madSQL.</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">QueriesPerSession</span> <span class="k">as</span>
<span class="k">select</span> <span class="nf">filterstopwords</span><span class="p">(</span><span class="nf">cqlkeywords</span><span class="p">(</span><span class="n">query</span><span class="p">))</span> <span class="k">as</span> <span class="n">cleanquery</span> <span class="p">,</span> <span class="n">sesidnew</span><span class="p">,</span> <span class="n">userid</span>
<span class="k">from</span> <span class="n">logs</span>
<span class="k">where</span> <span class="n">action</span> <span class="k">like</span> <span class="s1">&#39;search%&#39;</span> <span class="k">and</span> <span class="n">cleanquery</span><span class="o">!=</span><span class="s1">&#39;&#39;</span> <span class="k">and</span> <span class="nf">isvalidutf8</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">query</span><span class="p">,</span> <span class="n">sesidnew</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Step 4</strong></p>
<p>Aiming towards the extraction of term associations per country, an external data source is fetched from the web,
containing the mapping between IP ranges and countries.
Again, the <a class="reference internal" href="vtable.html#functions.vtable.file.file" title="functions.vtable.file.file"><tt class="xref py py-func docutils literal"><span class="pre">file()</span></tt></a> function is employed for fetching the URL resource and importing the corresponding data in a main memory
indexed table using the&nbsp;<a class="reference internal" href="vtable.html#functions.vtable.cache.cache" title="functions.vtable.cache.cache"><tt class="xref py py-func docutils literal"><span class="pre">cache()</span></tt></a> function of madIS.&nbsp;The fetched data source specifies the IP ranges in IP long number format,
so the logged IPs have to be converted to the same format by using <a class="reference internal" href="row.html#functions.row.iptools.ip2long" title="functions.row.iptools.ip2long"><tt class="xref py py-func docutils literal"><span class="pre">ip2long()</span></tt></a> function, and then to be subsequently matched
to the imported ranges. However, since each session may contain requests from multiple IPs (due to dynamic IPs, etc.),
it is only the first encountered IP that is considered for each session.
The first IP for each session is obtained using the <a class="reference internal" href="aggregate.html#functions.aggregate.selection.minrow" title="functions.aggregate.selection.minrow"><tt class="xref py py-func docutils literal"><span class="pre">minrow()</span></tt></a> function, comparing the corresponding records’ ids.
The generated mapping from each session to a country code is stored in table Session2Country.</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">create</span> <span class="n">temporary</span> <span class="k">table</span> <span class="n">Session2Country</span> <span class="k">as</span>
<span class="k">select</span> <span class="n">sesidnew</span><span class="p">,</span> <span class="n">CountryCode</span>
<span class="k">from</span>
     <span class="p">(</span><span class="k">select</span> <span class="nf">ip2long</span><span class="p">(</span><span class="nf">minrow</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">userip</span><span class="p">))</span> <span class="k">as</span> <span class="n">iplong</span><span class="p">,</span> <span class="n">sesidnew</span>
             <span class="k">from</span> <span class="n">logs</span>
             <span class="k">group</span> <span class="k">by</span> <span class="n">sesidnew</span><span class="p">),</span>
     <span class="p">(</span><span class="n">cache</span> <span class="k">select</span> <span class="nf">cast</span><span class="p">(</span><span class="n">C3</span> <span class="k">as</span> <span class="kt">integer</span><span class="p">)</span> <span class="k">as</span> <span class="n">ipfrom</span><span class="p">,</span> <span class="nf">cast</span><span class="p">(</span><span class="n">C4</span> <span class="k">as</span> <span class="kt">integer</span><span class="p">)</span> <span class="k">as</span> <span class="n">ipto</span><span class="p">,</span> <span class="n">C5</span> <span class="k">as</span> <span class="n">CountryCode</span>
             <span class="k">from</span> <span class="nf">file</span><span class="p">(</span><span class="s1">&#39;http://.../GeoIPCountryCSV.zip&#39;</span><span class="p">,</span><span class="s1">&#39;dialect:csv&#39;</span><span class="p">,</span><span class="s1">&#39;compression:t&#39;</span><span class="p">))</span>
<span class="k">where</span> <span class="n">iplong</span><span class="o">&gt;=</span><span class="n">ipfrom</span> <span class="k">and</span> <span class="n">iplong</span> <span class="o">&lt;=</span> <span class="n">ipto</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Step 5</strong></p>
<p>Then information regarding text of queries, and session to country mappings is jointly used so as to extract term associations,
with an <a class="reference external" href="http://en.wikipedia.org/wiki/Apriori_algorithm">apriori-like</a> technique, using the aggregate function <a class="reference internal" href="aggregate.html#functions.aggregate.mining.freqitemsets" title="functions.aggregate.mining.freqitemsets"><tt class="xref py py-func docutils literal"><span class="pre">freqitemsets()</span></tt></a>.
Frequent query term sets are computed over each one of the country codes that occur in Session2Country table.</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">FrequentItemsets</span> <span class="k">as</span>
<span class="k">select</span> <span class="s1">&#39;nat&#39;</span><span class="p">,</span> <span class="n">CountryCode</span><span class="p">,</span>
     <span class="nf">freqitemsets</span><span class="p">(</span><span class="n">cleanquery</span><span class="p">,</span><span class="s1">&#39;threshold:2&#39;</span><span class="p">,</span><span class="s1">&#39;maxlen:5&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">QueriesPerSession</span> <span class="k">as</span> <span class="n">qs</span><span class="p">,</span> <span class="n">Session2Country</span> <span class="k">as</span> <span class="n">sc</span>
<span class="k">where</span>  <span class="n">qs</span><span class="p">.</span><span class="n">sesidnew</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="n">sesidnew</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">CountryCode</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/madislog.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Examples</a><ul>
<li><a class="reference internal" href="#pivot">Pivot</a></li>
<li><a class="reference internal" href="#application-scenario">Application scenario</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="usefulnotes.html"
                        title="previous chapter">Useful notes</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="row.html"
                        title="next chapter">Row functions list</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/examples.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="row.html" title="Row functions list"
             >next</a> |</li>
        <li class="right" >
          <a href="usefulnotes.html" title="Useful notes"
             >previous</a> |</li>
        <li><a href="index.html">madIS 1.9 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2010, L. Stamatogiannakis, M. Triantafyllidi, M. Vayanou, M. Kyriakidi.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>